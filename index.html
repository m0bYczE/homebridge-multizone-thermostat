<html>
	<head>
		<link rel="stylesheet" type="text/css" href="index.css">
		<script src="jquery.min.js"></script>
	</head>
	<body>
		<div id="main" class="main">
			LOADING...
		</div>
		<br></br>
		<div id="data" class="stat"></div>
		<br/>
		<a href=".">reload</a>	
		<script>
			var refreshTimer;
			var dataCache="";
			var sendUpdates=false;
			var currentRefreshInterval=0;
			// flow is
			// click
			// stop intervals
			// update data cache and disply the update
			// pend a put of the update with a 3 sec timer
			// when timer fires
			// post the update
			// clear the post flag
			// get fresh data
			// reset the timer to 10 sec
			function buttonClick(e){
				clearInterval(refreshTimer);
				refreshTimer=null;
				var zone=e.split('.')[0];
				var action=e.split('.')[1];
				var setPoint=70;
				console.log(zone);
				for(var z in dataCache){
					if( zone==dataCache[z].name ){
						//console.log("found");
						setPoint=dataCache[z].setPoint + (action=='+'?1:-1);
						dataCache[z].setPoint=setPoint;
						break;
					}
				}
				sendUpdates=true;
				displayData(dataCache);
				startInterval();
			}
			function displayData(data){
				dataCache=data;
				$("#data").text("OK");
				$("#main").html("");
				for(var z in data){
					var zone=data[z].name;
					var currentTemp=data[z].currentTemp;
					var setPoint=data[z].setPoint;
					var running=data[z].running;
					var currentReads="";
					for(var r in data[z].currentReads){
						currentReads+=data[z].currentReads[r].location + " = " + data[z].currentReads[r].temp+"<br/>";
					}
					$("#main").append(
						'<div id="'+zone+'" class="zone">'+
							'<div class="h3">'+zone+'</div>'+
							'<div class="'+(running?'tempRun':'tempOff')+'">'+currentTemp+'</div>'+
							'<div class="ctrl">'+
								'<button class="button" onclick="buttonClick('+"'"+zone+".+'"+')">+</button>'+
								'<div class="setpt"><span class="set">'+setPoint+'</span><span class="lbl">set</span></div>'+
								'<button class="button" onclick="buttonClick('+"'"+zone+".-'"+')">-</button>'+
							'</div>'+
							'<div class="readings">'+currentReads+'</div>'+
						'</div>');
				}
			}
			function moveData(){
				if(sendUpdates){
					sendUpdates=false;
					for(var z in dataCache){
						var zone=dataCache[z].name;
						var setPoint=dataCache[z].setPoint;
						// need to push only changes
						console.log("set "+ zone+ " = " + setPoint);
						$.ajax({
			            	type: 'PUT',
			            	url: '/set/'+zone+'/'+setPoint,						
			            	error: function(err) {
			                	$("#data").text("Error on PUT");
								console.log(JSON.stringify(err));
			            	}
			        	});
					}
					startInterval();
				}
				else{
					console.log("get");
					$.ajax({
			            type: 'GET',
			            url: '/status',						
			            error: function(err) {
			                $("#data").text("Error on GET");
							console.log(JSON.stringify(err));
			            }
			        }).done(function(data){
						if(data)displayData(data);	
					});
					if(currentRefreshInterval<15000){
						startInterval(15000);
					}
				}
			}
			
			function startInterval(timeout){
				if(refreshTimer)clearInterval(refreshTimer);
				refreshTimer=null;
				currentRefreshInterval=( Number(timeout)>3000 )?Number(timeout):3000;
				console.log("Wait "+currentRefreshInterval);
				refreshTimer=setInterval(moveData,currentRefreshInterval);
			}
			$(startInterval);
		</script>
	</body>
</html>